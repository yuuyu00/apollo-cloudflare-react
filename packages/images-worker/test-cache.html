<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Worker Cache Test</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      h1 {
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
      }
      .test-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .image-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }
      .image-box {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
      }
      .image-box img {
        width: 100%;
        height: auto;
        border-radius: 4px;
      }
      .metrics {
        font-size: 12px;
        color: #666;
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
        font-family: monospace;
      }
      .cache-status {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 3px;
        font-weight: bold;
        margin-left: 5px;
      }
      .cache-hit {
        background: #28a745;
        color: white;
      }
      .cache-miss {
        background: #dc3545;
        color: white;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .log-container {
        background: #1e1e1e;
        color: #fff;
        padding: 15px;
        border-radius: 4px;
        font-family: "Consolas", "Monaco", monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 20px;
      }
      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-left: 3px solid #007bff;
        padding-left: 10px;
      }
      .log-entry.hit {
        border-left-color: #28a745;
      }
      .log-entry.miss {
        border-left-color: #dc3545;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }
      .stat-card {
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
      }
      .stat-label {
        color: #666;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #333;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <h1>üñºÔ∏è Image Worker Cache Test Dashboard</h1>

    <div class="test-section">
      <h2>Test Controls</h2>
      <button onclick="testCache()">Run Cache Test</button>
      <button onclick="clearTestImages()">Clear Test Images</button>
      <button onclick="testMultipleFormats()">Test Format Negotiation</button>
      <button onclick="clearLogs()">Clear Logs</button>

      <div class="stats-grid" id="stats">
        <div class="stat-card">
          <div class="stat-label">Total Requests</div>
          <div class="stat-value" id="totalRequests">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Cache Hits</div>
          <div class="stat-value" id="cacheHits" style="color: #28a745">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Cache Misses</div>
          <div class="stat-value" id="cacheMisses" style="color: #dc3545">
            0
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Hit Rate</div>
          <div class="stat-value" id="hitRate">0%</div>
        </div>
      </div>
    </div>

    <div class="test-section">
      <h2>Test Images</h2>
      <div id="imageContainer" class="image-container"></div>
    </div>

    <div class="test-section">
      <h2>Request Log</h2>
      <div id="logContainer" class="log-container">
        <div class="log-entry">Waiting for tests...</div>
      </div>
    </div>

    <script>
      // Test URLs - ÂÆüÈöõ„ÅÆÊú¨Áï™Áí∞Â¢É„ÅÆÁîªÂÉèURL
      const TEST_IMAGE_URLS = [
        "https://images.dev.yu-f87ct9a.dev/images/articles/7/b01b358d-9f64-40b3-9b65-f37b21a59c3b.jpg?type=content",
        "https://images.dev.yu-f87ct9a.dev/images/articles/7/3032f673-008c-4ccb-aa86-151ee9c93b63.jpg?type=content",
        "https://images.dev.yu-f87ct9a.dev/images/articles/7/3583d964-6565-4cc8-9b34-0ce4a5aac2b5.jpg?type=content",
      ];

      let stats = {
        total: 0,
        hits: 0,
        misses: 0,
      };

      function updateStats() {
        document.getElementById("totalRequests").textContent = stats.total;
        document.getElementById("cacheHits").textContent = stats.hits;
        document.getElementById("cacheMisses").textContent = stats.misses;
        const hitRate =
          stats.total > 0 ? ((stats.hits / stats.total) * 100).toFixed(1) : 0;
        document.getElementById("hitRate").textContent = `${hitRate}%`;
      }

      function addLog(message, type = "info") {
        const logContainer = document.getElementById("logContainer");
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;
        const timestamp = new Date().toLocaleTimeString();
        entry.innerHTML = `[${timestamp}] ${message}`;
        logContainer.insertBefore(entry, logContainer.firstChild);

        // Keep only last 50 entries
        while (logContainer.children.length > 50) {
          logContainer.removeChild(logContainer.lastChild);
        }
      }

      function clearLogs() {
        document.getElementById("logContainer").innerHTML =
          '<div class="log-entry">Logs cleared</div>';
      }

      async function fetchImageWithMetrics(url) {
        const startTime = performance.now();

        // Add cache-busting query parameter to bypass browser cache completely
        const cacheBuster = `cb=${Date.now()}_${Math.random()}`;
        const urlWithCacheBuster = url.includes("?")
          ? `${url}&${cacheBuster}`
          : `${url}?${cacheBuster}`;

        try {
          // Aggressive cache bypass settings
          const response = await fetch(urlWithCacheBuster, {
            method: "GET",
            cache: "no-store", // Most aggressive - bypass all caches
            mode: "cors", // Enable CORS
            credentials: "omit", // Don't send cookies
            headers: {
              "Cache-Control": "no-cache, no-store, must-revalidate",
              Pragma: "no-cache",
              Expires: "0",
            },
          });

          const endTime = performance.now();
          const duration = (endTime - startTime).toFixed(2);

          const cacheStatus =
            response.headers.get("X-Cache-Status") || "UNKNOWN";
          const cfCacheStatus =
            response.headers.get("CF-Cache-Status") || "N/A";
          const contentType = response.headers.get("Content-Type") || "unknown";
          const cacheControl = response.headers.get("Cache-Control") || "none";

          // Update stats
          stats.total++;
          if (cacheStatus === "HIT") {
            stats.hits++;
          } else if (cacheStatus === "MISS") {
            stats.misses++;
          }
          updateStats();

          // Create blob URL for image display
          const blob = await response.blob();
          const imageUrl = URL.createObjectURL(blob);

          return {
            url: imageUrl,
            originalUrl: url,
            cacheStatus,
            cfCacheStatus,
            duration,
            contentType,
            cacheControl,
            size: blob.size,
          };
        } catch (error) {
          addLog(`Error fetching ${url}: ${error.message}`, "error");
          return null;
        }
      }

      async function testCache() {
        const container = document.getElementById("imageContainer");
        container.innerHTML = "<p>Loading test images...</p>";

        addLog("Starting cache test...", "info");

        // Reset stats
        stats = { total: 0, hits: 0, misses: 0 };
        updateStats();

        const results = [];

        // First round - should be MISS
        addLog("Round 1: Initial requests (expecting MISS)", "info");
        for (const url of TEST_IMAGE_URLS) {
          const result = await fetchImageWithMetrics(url);
          if (result) {
            const filename = url.split("/").pop().split("?")[0];
            results.push({ ...result, filename, round: 1 });
            addLog(
              `${filename}: ${result.cacheStatus} - ${result.duration}ms`,
              result.cacheStatus === "HIT" ? "hit" : "miss"
            );
          }
        }

        // Wait a bit
        await new Promise((resolve) => setTimeout(resolve, 1000));

        // Second round - should be HIT
        addLog("Round 2: Repeated requests (expecting HIT)", "info");
        for (const url of TEST_IMAGE_URLS) {
          const result = await fetchImageWithMetrics(url);
          if (result) {
            const filename = url.split("/").pop().split("?")[0];
            results.push({ ...result, filename, round: 2 });
            addLog(
              `${filename}: ${result.cacheStatus} - ${result.duration}ms`,
              result.cacheStatus === "HIT" ? "hit" : "miss"
            );
          }
        }

        // Display results
        displayResults(results);
      }

      function displayResults(results) {
        const container = document.getElementById("imageContainer");
        container.innerHTML = "";

        // Group by round
        const rounds = {};
        results.forEach((r) => {
          if (!rounds[r.round]) rounds[r.round] = [];
          rounds[r.round].push(r);
        });

        Object.entries(rounds).forEach(([round, items]) => {
          const roundDiv = document.createElement("div");
          roundDiv.innerHTML = `<h3>Round ${round}</h3>`;

          const grid = document.createElement("div");
          grid.className = "image-container";

          items.forEach((item) => {
            const box = document.createElement("div");
            box.className = "image-box";
            box.innerHTML = `
                        <img src="${item.url}" alt="${item.filename}" />
                        <div class="metrics">
                            <strong>${item.filename}</strong> (${item.type})<br>
                            Cache Status: <span class="cache-status ${
                              item.cacheStatus === "HIT"
                                ? "cache-hit"
                                : "cache-miss"
                            }">${item.cacheStatus}</span><br>
                            Load Time: ${item.duration}ms<br>
                            Content-Type: ${item.contentType}<br>
                            Size: ${(item.size / 1024).toFixed(2)} KB<br>
                            Cache-Control: ${item.cacheControl}
                        </div>
                    `;
            grid.appendChild(box);
          });

          roundDiv.appendChild(grid);
          container.appendChild(roundDiv);
        });
      }

      function clearTestImages() {
        document.getElementById("imageContainer").innerHTML =
          "<p>Images cleared</p>";
        addLog("Test images cleared", "info");
      }

      async function testMultipleFormats() {
        addLog("Testing format negotiation...", "info");

        const formats = [
          { accept: "image/avif", expected: "avif" },
          { accept: "image/webp", expected: "webp" },
          { accept: "image/jpeg", expected: "jpeg" },
        ];

        // Use the first test image URL for format testing
        const baseUrl = TEST_IMAGE_URLS[0];

        for (const format of formats) {
          try {
            const response = await fetch(baseUrl, {
              headers: { Accept: format.accept },
            });

            const contentType = response.headers.get("Content-Type");
            const cacheStatus = response.headers.get("X-Cache-Status");

            addLog(
              `Format ${format.expected}: ${contentType} (${cacheStatus})`,
              cacheStatus === "HIT" ? "hit" : "miss"
            );
          } catch (error) {
            addLog(
              `Error testing ${format.expected}: ${error.message}`,
              "error"
            );
          }
        }
      }

      // Auto-run test on load
      window.addEventListener("load", () => {
        addLog(
          'Cache test dashboard loaded. Click "Run Cache Test" to begin.',
          "info"
        );
      });
    </script>
  </body>
</html>
